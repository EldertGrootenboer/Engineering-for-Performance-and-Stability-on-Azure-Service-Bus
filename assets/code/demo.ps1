# Demo 1
$senders = 1
$receivers = 1
$inflightSends = 1
$inflightReceives = 1
$prefetchCount = 0
$sendBatchCount = 0
$receiveBatchCount = 0

# Demo 2
# $senders = 50
# $receivers = 100
# $inflightSends = 1
# $inflightReceives = 1
# $prefetchCount = 0
# $sendBatchCount = 0
# $receiveBatchCount = 0

# Demo 3
# $senders = 1
# $receivers = 1
# $inflightSends = 100
# $inflightReceives = 100
# $prefetchCount = 0
# $sendBatchCount = 0
# $receiveBatchCount = 0

# # Demo 4
# $senders = 50
# $receivers = 100
# $inflightSends = 100
# $inflightReceives = 100
# $prefetchCount = 0
# $sendBatchCount = 0
# $receiveBatchCount = 0

# # Demo 5
# $senders = 50
# $receivers = 100
# $inflightSends = 100
# $inflightReceives = 100
# $prefetchCount = 100
# $sendBatchCount = 200
# $receiveBatchCount = 0

# Settings
$queue = "queue-lm-"
$debugMode = $true
[Int]$suffix = 0
$suffixCounterPath = "C:\Repositories\service-bus-dotnet-messaging-performance\ThroughputTest\counter.txt"

# Suffix counter
Get-Content -Path $suffixCounterPath | ForEach-Object { $suffix = $_ }

# Calculated values
$previousSuffix = $suffix - 1
$nextSuffix = $suffix + 1
$newQueue = $queue + $suffix
$previousQueue = $queue + $previousSuffix

# Add 1 to suffix and update suffix counter in file
Set-Content -Path $suffixCounterPath -Value $nextSuffix

# Create infrastructure
az servicebus queue delete --name $previousQueue --resource-group rg-eldert-pg --namespace-name sb-eldert-pg-performance-test-1-partition
az servicebus queue create --name $newQueue --resource-group rg-eldert-pg --namespace-name sb-eldert-pg-performance-test-1-partition --max-size 81920

# Run locally
Set-Location "C:\Repositories\service-bus-dotnet-messaging-performance\ThroughputTest\bin\Release\net7.0"
dotnet ThroughputTest.dll -C '<service-bus-connection-string>' -S $newQueue -r $receivers -s $senders -D $debugMode -i $inflightSends -j $inflightReceives -e $prefetchCount -t $sendBatchCount -v $receiveBatchCount

# Results
### Results Demo 1 ###
# S|    pstart|      pend|  sbc| mifs|   snd.avg|   snd.med|   snd.dev|   snd.min|   snd.max|   gld.avg|   gld.med|   gld.dev|   gld.min|   gld.max|     msg/s|     total|     sndop|      errs|      busy|   overall|
# R|    pstart|      pend|  rbc| mifr|   rcv.avg|   rcv.med|   rcv.dev|   rcv.min|   rcv.max|   cpl.avg|   cpl.med|   cpl.dev|   cpl.min|   cpl.max|     msg/s|     total|     rcvop|      errs|      busy|   overall|
# R|         1|        20|    0|    1|      3.10|      2.03|     20.05|      1.44|    440.56|     43.89|     33.83|     31.03|     21.63|    155.36|     42.30|       846|       846|         0|         0|       846|
# S|         1|        20|    0|    1|     38.81|     37.79|     14.75|     19.48|    120.92|    193.53|    136.68|     97.02|      0.22|    928.85|     50.05|      1001|      1001|         0|         0|      1001|
# S|        10|        30|    0|    1|     41.96|     38.70|     19.01|     19.48|    177.21|    209.25|    154.06|    115.47|     94.34|    995.57|     47.50|       950|       950|         0|         0|      1951|
# R|        10|        30|    0|    1|      2.06|      1.98|      0.52|      1.44|      7.73|     45.12|     34.24|     30.94|     21.63|    148.13|     42.40|       848|       848|         0|         0|      1694|
# R|        20|        40|    0|    1|      2.06|      2.00|      0.44|      1.49|      6.75|     45.71|     35.21|     30.83|     21.87|    169.95|     41.90|       838|       838|         0|         0|      2532|
# S|        20|        40|    0|    1|     45.95|     41.53|     20.19|     20.38|    177.21|    229.19|    239.00|    124.81|     97.56|   1074.51|     43.40|       868|       868|         0|         0|      2819|
# R|        30|        50|    0|    1|      2.03|      1.99|      0.34|      1.35|      6.75|     43.20|     34.75|     28.93|     21.98|    169.95|     44.20|       884|       884|         0|         0|      3416|
# S|        30|        50|    0|    1|     42.46|     40.20|     16.29|     19.66|    169.74|    212.00|    193.73|    105.90|     95.02|   1074.51|     47.05|       941|       941|         0|         0|      3760|
# S|        40|        60|    0|    1|     38.40|     37.61|     14.22|     19.66|    124.18|    191.69|    138.32|     93.66|     92.73|    778.52|     51.95|      1039|      1039|         0|         0|      4799|
# R|        40|        60|    0|    1|      2.04|      1.99|      0.36|      1.35|      5.93|     42.94|     34.06|     29.33|     20.81|    145.89|     44.45|       889|       889|         0|         0|      4305|
# R|        50|        70|    0|    1|      2.09|      2.01|      0.48|      1.41|      7.05|     44.94|     34.47|     31.68|     20.81|    143.11|     42.50|       850|       850|         0|         0|      5155|
# S|        50|        70|    0|    1|     36.68|     37.07|     14.49|     18.42|    170.44|    183.05|    122.68|     97.67|     90.60|   1392.16|     54.35|      1087|      1087|         0|         0|      5886|
### Results Demo 2 ###
# S|    pstart|      pend|  sbc| mifs|   snd.avg|   snd.med|   snd.dev|   snd.min|   snd.max|   gld.avg|   gld.med|   gld.dev|   gld.min|   gld.max|     msg/s|     total|     sndop|      errs|      busy|   overall|
# R|    pstart|      pend|  rbc| mifr|   rcv.avg|   rcv.med|   rcv.dev|   rcv.min|   rcv.max|   cpl.avg|   cpl.med|   cpl.dev|   cpl.min|   cpl.max|     msg/s|     total|     rcvop|      errs|      busy|   overall|
# R|         1|        62|    0|    1|    176.76|     27.18|   2423.55|      0.86|  41517.74|     46.10|     27.17|    325.58|      0.00|  40806.78|   2728.75|     54575|     54575|        99|         0|     80180|
# S|        11|        62|    0|    1|     67.48|     29.51|    925.29|     11.60|  40848.11|    396.63|    142.10|   8106.84|      0.00| 408121.99|   2732.90|     54658|     54658|         0|         0|     80614|
# R|        52|        72|    0|    1|     31.54|     28.29|     40.26|      0.83|    835.43|     41.14|     27.37|     44.58|      7.95|    785.50|   2777.10|     55542|     55542|         0|         0|    135722|
# S|        52|        72|    0|    1|     36.04|     29.75|     35.34|     11.60|    803.87|    180.13|    143.81|    249.55|      0.01|   7787.31|   2780.25|     55605|     55605|         0|         0|    136219|
# R|        62|        82|    0|    1|     29.38|     25.08|     39.84|      0.80|    835.43|     42.51|     27.14|     46.07|      7.95|    785.50|   2797.75|     55955|     55955|         0|         0|    191677|
# S|        62|        82|    0|    1|     35.93|     29.61|     35.37|     11.72|    803.87|    179.52|    143.85|    249.97|      2.42|   7787.31|   2796.50|     55930|     55930|         0|         0|    192149|
# R|        72|        92|    0|    1|     29.45|     27.50|     23.08|      0.80|    224.76|     39.33|     26.42|     32.94|      8.70|    261.63|   2938.50|     58770|     58770|         0|         0|    250447|
# S|        72|        92|    0|    1|     34.42|     29.52|     14.29|     11.72|    194.11|    171.63|    143.62|     97.37|      2.42|   1794.55|   2922.95|     58459|     58459|         0|         0|    250608|
# R|        82|       102|    0|    1|     30.26|     28.74|     23.82|      0.81|    224.76|     37.25|     25.98|     30.13|      8.29|    261.63|   2987.55|     59751|     59751|         0|         0|    310198|
# S|        82|       102|    0|    1|     33.65|     29.01|     13.62|     12.58|    194.11|    167.86|    142.06|     90.99|      7.89|   1794.55|   2989.50|     59790|     59790|         0|         0|    310398|
# R|        92|       112|    0|    1|     28.30|     25.48|     22.85|      0.80|    223.62|     39.46|     26.49|     31.83|      8.29|    195.40|   2968.45|     59369|     59369|         0|         0|    369567|
# S|        92|       112|    0|    1|     33.82|     28.99|     12.68|     12.58|    191.31|    168.71|    141.38|     81.10|      7.89|   1430.67|   2966.70|     59334|     59334|         0|         0|    369732|
# R|       102|       122|    0|    1|     26.74|     20.81|     24.35|      0.79|    285.02|     43.63|     27.63|     34.77|      8.56|    195.40|   2867.45|     57349|     57349|         0|         0|    426916|
# S|       102|       122|    0|    1|     35.00|     30.14|     13.89|     15.12|    240.10|    175.11|    144.29|     89.86|      0.52|   1436.63|   2862.15|     57243|     57243|         0|         0|    426975|
# R|       112|       132|    0|    1|     26.71|     20.71|     25.81|      0.79|    285.02|     44.93|     28.12|     35.41|      8.48|    235.61|   2826.70|     56534|     56534|         0|         0|    483450|
# S|       112|       132|    0|    1|     35.30|     30.22|     14.88|     14.76|    241.95|    176.56|    145.49|     98.94|      0.52|   2285.72|   2851.90|     57038|     57038|         0|         0|    484013|
### Results Demo 3 ###
# S|    pstart|      pend|  sbc| mifs|   snd.avg|   snd.med|   snd.dev|   snd.min|   snd.max|   gld.avg|   gld.med|   gld.dev|   gld.min|   gld.max|     msg/s|     total|     sndop|      errs|      busy|   overall|
# R|    pstart|      pend|  rbc| mifr|   rcv.avg|   rcv.med|   rcv.dev|   rcv.min|   rcv.max|   cpl.avg|   cpl.med|   cpl.dev|   cpl.min|   cpl.max|     msg/s|     total|     rcvop|      errs|      busy|   overall|
# R|         1|        20|    0|  100|      7.42|      5.91|     19.89|      2.39|    500.73|     36.16|     26.26|     30.05|      9.08|    205.83|   2297.90|     45958|     45958|         0|         0|     45958|
# S|         1|        20|    0|  100|     22.36|     20.44|      8.17|     10.29|    161.86|      2.01|      0.00|     13.51|      0.00|   1367.37|   4367.75|     87355|     87355|         0|         0|     87355|
# R|        10|        30|    0|  100|      6.37|      5.89|      4.91|      2.44|    214.61|     37.20|     26.10|     32.96|      9.08|    271.07|   2326.65|     46533|     46533|         0|         0|     92491|
# S|        10|        31|    0|  100|     22.15|     20.13|     12.58|      9.81|    266.19|      2.00|      0.00|     15.79|      0.00|   2422.88|   4578.15|     91563|     91563|         0|         0|    178918|
# R|        20|        41|    0|  100|      6.37|      5.83|      4.99|      2.43|    214.61|     36.87|     26.17|     31.90|      9.13|    271.07|   2347.75|     46955|     46955|         0|         0|    139446|
# S|        20|        41|    0|  100|     22.16|     20.37|     12.14|      9.81|    266.19|      2.00|      0.00|     15.36|      0.00|   2422.88|   4607.30|     92146|     92146|         0|         0|    271064|
# R|        30|        51|    0|  100|      6.27|      5.80|      3.01|      2.36|     52.06|     34.99|     26.00|     29.83|      9.31|    290.93|   2455.25|     49105|     49105|         0|         0|    188551|
# S|        31|        51|    0|  100|     22.60|     20.71|     11.75|     10.12|    293.63|      2.05|      0.00|     16.04|      0.00|   2738.88|   4499.30|     89986|     89986|         0|         0|    361050|
# R|        41|        61|    0|  100|      6.08|      5.70|      2.88|      2.36|     49.47|     34.42|     26.25|     28.53|      8.79|    290.93|   2504.00|     50080|     50080|         0|         0|    238631|
# S|        41|        61|    0|  100|     22.92|     20.63|     12.05|     10.05|    293.63|      2.08|      0.00|     16.50|      0.00|   2738.88|   4427.10|     88542|     88542|         0|         0|    449592|
# R|        51|        71|    0|  100|      6.03|      5.63|      3.24|      2.28|    115.75|     34.99|     26.55|     27.19|      8.79|    144.15|   2470.70|     49414|     49414|         0|         0|    288045|
# S|        51|        71|    0|  100|     22.50|     20.47|      8.10|     10.05|    146.01|      2.03|      0.00|     13.63|      0.00|   1153.61|   4512.15|     90243|     90243|         0|         0|    539835|
### Results Demo 4 ###
# S|    pstart|      pend|  sbc| mifs|   snd.avg|   snd.med|   snd.dev|   snd.min|   snd.max|   gld.avg|   gld.med|   gld.dev|   gld.min|   gld.max|     msg/s|     total|     sndop|      errs|      busy|   overall|
# R|    pstart|      pend|  rbc| mifr|   rcv.avg|   rcv.med|   rcv.dev|   rcv.min|   rcv.max|   cpl.avg|   cpl.med|   cpl.dev|   cpl.min|   cpl.max|     msg/s|     total|     rcvop|      errs|      busy|   overall|
# R|        13|        50|    0|  100|   4080.20|    882.55|   9746.92|    365.59|  34892.12|    800.35|    798.39|    259.89|      0.00|  32815.55|   5074.50|    101490|    101490|      3243|         0|    143251|
# S|        10|        53|    0|  100|   1058.60|    774.18|   2061.23|    362.28|  33984.26|    144.62|      0.00|   4306.86|      0.00| 327839.19|   5777.70|    115554|    115554|         0|         0|    172820|
# R|        40|        61|    0|  100|    926.54|    896.41|    193.86|    439.65|   2121.93|    767.62|    736.80|    155.19|    443.69|   1611.40|   6078.65|    121573|    121573|         0|         0|    264824|
# S|        43|        64|    0|  100|    721.02|    708.37|    151.38|    420.32|   1609.12|     69.02|      0.00|    359.33|      0.00|   7781.58|   6168.00|    123360|    123360|         0|         0|    296180|
# R|        50|        71|    0|  100|    936.47|    898.55|    240.87|    362.61|   2154.30|    664.55|    622.69|    159.58|    362.56|   1611.40|   6507.55|    130151|    130151|         0|         0|    394975|
# S|        53|        74|    0|  100|    614.85|    581.10|    146.45|    354.54|   1395.52|     58.26|      0.00|    320.44|      0.00|   8472.90|   6544.75|    130895|    130895|         0|         0|    427075|
# R|        61|        82|    0|  100|    938.97|    895.01|    266.99|    362.61|   2264.30|    576.72|    535.92|    142.10|    292.29|   1174.78|   6913.85|    138277|    138277|         0|         0|    533252|
# S|        64|        84|    0|  100|    527.45|    499.75|    144.02|    256.47|   1368.65|     49.67|      0.00|    297.18|      0.00|   8472.90|   6828.35|    136567|    136567|         0|         0|    563642|
# R|        71|        91|    0|  100|    969.49|    916.01|    331.96|    243.16|   3054.96|    493.97|    462.99|    142.23|    243.27|   1193.31|   7121.05|    142421|    142421|         0|         0|    675673|
# S|        74|        95|    0|  100|    440.97|    417.32|    139.93|    154.84|   1201.39|     41.38|      0.00|    259.11|      0.00|   8076.16|   6993.85|    139877|    139877|         0|         0|    703519|
# R|        82|       102|    0|  100|   1023.97|    952.52|    420.96|    200.39|   4810.20|    411.54|    376.22|    140.59|    173.43|   1201.25|   7279.85|    145597|    145597|         0|         0|    821270|
# S|        84|       105|    0|  100|    358.54|    346.51|    127.77|    137.25|   1174.60|     33.11|      0.00|    225.87|      0.00|   8076.16|   7160.90|    143218|    143218|         0|         0|    846737|
# R|        92|       113|    0|  100|   1070.13|    993.33|    474.85|    200.10|   5004.88|    360.94|    340.74|    128.48|    136.94|   1201.25|   7363.00|    147260|    147260|         0|         0|    968530|
# S|        95|       115|    0|  100|    308.39|    274.74|    118.83|    137.25|   1174.60|     28.02|      0.00|    206.54|      0.00|   6096.69|   7272.40|    145448|    145448|         0|         0|    992185|
# R|       102|       123|    0|  100|   1041.53|    902.54|    507.16|    178.80|   5004.88|    392.33|    335.58|    182.20|     75.15|   1263.11|   7315.50|    146310|    146310|         0|         0|   1114840|
# S|       105|       125|    0|  100|   1313.66|    287.86|   7090.33|     78.51|  82456.39|    126.94|      0.00|   7096.49|      0.00| 816930.27|   7292.35|    145847|    145847|         0|         0|   1138032|
### Results Demo 5 ###
# S|    pstart|      pend|  sbc| mifs|   snd.avg|   snd.med|   snd.dev|   snd.min|   snd.max|   gld.avg|   gld.med|   gld.dev|   gld.min|   gld.max|     msg/s|     total|     sndop|      errs|      busy|   overall|
# R|    pstart|      pend|  rbc| mifr|   rcv.avg|   rcv.med|   rcv.dev|   rcv.min|   rcv.max|   cpl.avg|   cpl.med|   cpl.dev|   cpl.min|   cpl.max|     msg/s|     total|     rcvop|      errs|      busy|   overall|
# R|         1|         1|    0|  100|  16972.88|  17201.84|   1071.89|    689.51|  19007.36|   2575.66|   2698.55|   1044.06|      0.00|  14925.14|     42.20|       844|       844|       103|         0|       844|
# S|         1|        14|  200|  100|  12193.94|  11044.26|   6172.33|   3794.32|  26611.12|      0.01|      0.00|      0.01|      0.00|      0.21|  12250.00|    245000|      1225|         0|         0|    245000|
# R|         1|        20|    0|  100|  16951.28|  17826.87|   4048.94|      0.02|  19729.81|   7806.56|   8996.40|   2520.90|      0.00|  14925.14|    526.40|     10528|     10528|       370|         0|     11372|
# S|         7|        15|  200|  100|  17915.83|  17986.37|   7948.64|   3794.32|  36259.74|      0.00|      0.00|      0.01|      0.00|      0.17|  29130.00|    582600|      2913|         0|         0|    827600|
# R|        12|        28|    0|  100|   8970.52|   6730.63|   8465.92|      0.01|  19729.81|   7285.23|   6663.13|   1761.15|      0.00|  10905.32|   1023.30|     20466|     20466|       267|         0|     31838|
# S|         1|        11|  200|  100|  26298.24|  26299.78|   7975.13|  12117.19|  44778.38|      0.00|      0.00|      0.00|      0.00|      0.17|  31050.00|    621000|      3105|         0|         0|   1448600|
# R|        23|        44|    0|  100|   2355.85|     59.43|   3083.69|      0.01|   9622.65|   6451.11|   6282.80|    574.37|   5352.79|   8474.70|    990.00|     19800|     19800|         0|         0|     51638|
# S|         2|        25|  200|  100|  33978.99|  34427.18|   5727.06|  21452.14|  49189.65|   1888.44|      0.00|  12129.10|      0.00| 154863.06|  29850.00|    597000|      2985|         0|         0|   2045600|
# R|        29|        54|    0|  100|   3496.68|   5407.14|   3285.08|      0.01|   7882.60|   6685.63|   6717.91|    557.91|   5668.85|   7959.20|    988.80|     19776|     19776|         0|         0|     71414|
# S|        17|        35|  200|  100|  34721.49|  33630.09|   3287.37|  31522.77|  49189.65|   3582.58|      0.00|  13250.56|      0.00| 154863.06|  29750.00|    595000|      2975|         0|         0|   2640600|
# R|        37|        62|    0|  100|   3619.57|   5958.49|   3384.12|      0.01|   7979.61|   6844.92|   6877.54|    571.49|   5668.85|   7959.20|    963.60|     19272|     19272|         0|         0|     90686|
# S|        20|        44|  200|  100|  33886.96|  34131.44|   1062.41|  31522.77|  38122.77|   3428.43|      0.00|   7536.48|      0.00|  52354.44|  28950.00|    579000|      2895|         0|         0|   3219600|
# R|        47|        75|    0|  100|   3718.02|   6212.87|   3484.32|      0.01|   8007.56|   6882.71|   6800.12|    522.86|   6092.71|   7899.34|    970.80|     19416|     19416|         0|         0|    110102|
# S|        35|        55|  200|  100|  34179.90|  34132.04|    861.02|  32306.86|  37389.18|   3293.03|      0.00|   7137.87|      0.00|  38258.64|  30450.00|    609000|      3045|         0|         0|   3828600|
# R|        57|        82|    0|  100|   3634.41|   5589.65|   3419.91|      0.01|   8007.56|   6731.55|   6956.36|    593.83|   5513.21|   7607.44|    990.00|     19800|     19800|         0|         0|    129902|
# S|        42|        63|  200|  100|  34393.27|  34355.21|   1090.28|  32306.86|  37791.08|   3288.89|      0.00|   7145.71|      0.00|  38258.64|  28350.00|    567000|      2835|         0|         0|   4395600|
# R|        67|        93|    0|  100|   3564.32|   5587.23|   3372.90|      0.01|   8344.39|   7167.87|   7062.81|    796.88|   5513.21|   8307.80|    847.50|     16950|     16950|         0|         0|    146852|
# S|        53|        74|  200|  100|  34962.56|  35112.41|    996.89|  33165.68|  37904.44|   3418.72|      0.00|   7410.29|      0.00|  40166.24|  28100.00|    562000|      2810|         0|         0|   4957600|
# R|        78|       103|    0|  100|   3857.48|   6337.47|   3631.08|      0.01|   8344.39|   7107.74|   6820.95|    669.87|   5673.84|   8307.80|    990.00|     19800|     19800|         0|         0|    166652|
# S|        62|        83|  200|  100|  35122.40|  35226.98|   1072.76|  33521.23|  38232.38|   3362.83|      0.00|   7260.57|      0.00|  40166.24|  28950.00|    579000|      2895|         0|         0|   5536600|